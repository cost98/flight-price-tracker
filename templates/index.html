<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚úàÔ∏è Flight Price Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tab-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(0,0,0,0.15);
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
        }
        
        .tab-content {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: auto;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .results {
            margin-top: 30px;
            display: none;
        }
        
        .results.show {
            display: block;
        }
        
        .flight-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }
        
        .flight-card.cheapest {
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-left: 4px solid #28a745;
        }
        
        .price {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .flight-card.cheapest .price {
            color: #28a745;
        }
        
        .itinerary {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
        }
        
        .segment {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px 0;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .segment:last-child {
            border-bottom: none;
        }
        
        .airport {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .arrow {
            color: #667eea;
            font-size: 1.5em;
        }
        
        .flight-info {
            color: #666;
            font-size: 0.9em;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 15px;
            background: #28a745;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 10px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading.show {
            display: block;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
        }
        
        .route-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #667eea;
        }
        
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .route-path {
            font-size: 1.2em;
            font-weight: 600;
            color: #333;
        }
        
        .route-price {
            font-size: 1.3em;
            font-weight: 700;
            color: #667eea;
        }
        
        .route-details {
            color: #666;
            font-size: 0.9em;
        }
        
        .api-warning {
            background: #fff3cd;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚úàÔ∏è Flight Price Tracker</h1>
            <p class="subtitle">Trova i migliori prezzi per i tuoi voli</p>
        </header>
        
        {% if not api_ready %}
        <div class="api-warning">
            <strong>‚ö†Ô∏è Attenzione:</strong> API Amadeus non configurata. 
            Aggiungi le credenziali nel file .env per utilizzare l'applicazione.
        </div>
        {% endif %}
        
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('search')">üîç Cerca Voli</button>
            <button class="tab-btn" onclick="switchTab('history')">üìä Storico Prezzi</button>
            <button class="tab-btn" onclick="switchTab('routes')">üó∫Ô∏è Rotte Monitorate</button>
        </div>
        
        <!-- TAB: Cerca Voli -->
        <div id="search-tab" class="tab-content active">
            <h2>üîç Cerca Voli</h2>
            
            <div class="error" id="search-error"></div>
            
            <form id="search-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="origin">Aeroporto di Partenza (IATA)</label>
                        <input type="text" id="origin" placeholder="es: FCO" maxlength="3" required>
                    </div>
                    <div class="form-group">
                        <label for="destination">Aeroporto di Destinazione (IATA)</label>
                        <input type="text" id="destination" placeholder="es: JFK" maxlength="3" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="departure_date">Data di Partenza</label>
                        <input type="date" id="departure_date" required>
                    </div>
                    <div class="form-group">
                        <label for="return_date">Data di Ritorno</label>
                        <input type="date" id="return_date">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="adults">Numero di Passeggeri</label>
                    <input type="number" id="adults" value="1" min="1" max="9" required>
                </div>
                
                <button type="submit" class="btn" {% if not api_ready %}disabled{% endif %}>
                    üîç Cerca Voli
                </button>
            </form>
            
            <div class="loading" id="search-loading">
                <div class="spinner"></div>
                <p>Ricerca voli in corso...</p>
            </div>
            
            <div class="results" id="search-results"></div>
        </div>
        
        <!-- TAB: Storico Prezzi -->
        <div id="history-tab" class="tab-content">
            <h2>üìä Storico Prezzi</h2>
            
            <div class="error" id="history-error"></div>
            
            <form id="history-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="hist_origin">Aeroporto di Partenza</label>
                        <input type="text" id="hist_origin" placeholder="FCO" maxlength="3" required>
                    </div>
                    <div class="form-group">
                        <label for="hist_destination">Aeroporto di Destinazione</label>
                        <input type="text" id="hist_destination" placeholder="JFK" maxlength="3" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="hist_departure">Data di Partenza</label>
                        <input type="date" id="hist_departure" required>
                    </div>
                    <div class="form-group">
                        <label for="hist_return">Data di Ritorno (opzionale)</label>
                        <input type="date" id="hist_return">
                    </div>
                </div>
                
                <button type="submit" class="btn">üìä Visualizza Trend</button>
            </form>
            
            <div class="loading" id="history-loading">
                <div class="spinner"></div>
                <p>Caricamento storico...</p>
            </div>
            
            <div class="results" id="history-results"></div>
        </div>
        
        <!-- TAB: Rotte Monitorate -->
        <div id="routes-tab" class="tab-content">
            <h2>üó∫Ô∏è Rotte Monitorate</h2>
            
            <button class="btn" onclick="loadRoutes()" style="margin-bottom: 20px;">üîÑ Aggiorna Lista</button>
            
            <div class="loading" id="routes-loading">
                <div class="spinner"></div>
                <p>Caricamento rotte...</p>
            </div>
            
            <div class="results" id="routes-results"></div>
        </div>
    </div>
    
    <script>
        // Imposta date predefinite
        const today = new Date();
        const departure = new Date(today);
        departure.setDate(today.getDate() + 30);
        const returnDate = new Date(departure);
        returnDate.setDate(departure.getDate() + 7);
        
        document.getElementById('departure_date').value = departure.toISOString().split('T')[0];
        document.getElementById('return_date').value = returnDate.toISOString().split('T')[0];
        document.getElementById('hist_departure').value = departure.toISOString().split('T')[0];
        
        // Switch tra tab
        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'routes') {
                loadRoutes();
            }
        }
        
        // Ricerca voli
        document.getElementById('search-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                origin: document.getElementById('origin').value.toUpperCase(),
                destination: document.getElementById('destination').value.toUpperCase(),
                departure_date: document.getElementById('departure_date').value,
                return_date: document.getElementById('return_date').value,
                adults: parseInt(document.getElementById('adults').value)
            };
            
            document.getElementById('search-loading').classList.add('show');
            document.getElementById('search-results').classList.remove('show');
            document.getElementById('search-error').classList.remove('show');
            
            try {
                const response = await fetch('/api/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    displaySearchResults(result.offers, data.origin, data.destination);
                } else {
                    showError('search-error', result.error);
                }
            } catch (error) {
                showError('search-error', 'Errore di connessione: ' + error.message);
            } finally {
                document.getElementById('search-loading').classList.remove('show');
            }
        });
        
        // Visualizza risultati ricerca
        function displaySearchResults(offers, origin, destination) {
            const resultsDiv = document.getElementById('search-results');
            
            if (!offers || offers.length === 0) {
                resultsDiv.innerHTML = '<p>‚ùå Nessun volo trovato per questa rotta.</p>';
                resultsDiv.classList.add('show');
                return;
            }
            
            const cheapest = offers.reduce((min, offer) => 
                offer.price.total < min.price.total ? offer : min
            );
            
            let html = `<h3>‚úÖ Trovati ${offers.length} voli per ${origin} ‚Üí ${destination}</h3>`;
            
            offers.forEach((offer, idx) => {
                const isCheapest = offer.id === cheapest.id;
                html += `
                    <div class="flight-card ${isCheapest ? 'cheapest' : ''}">
                        ${isCheapest ? '<span class="badge">üèÜ PI√ô ECONOMICO</span>' : ''}
                        <div class="price">‚Ç¨ ${offer.price.total}</div>
                        ${formatItineraries(offer.itineraries)}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }
        
        // Formatta itinerari
        function formatItineraries(itineraries) {
            let html = '';
            itineraries.forEach((itinerary, idx) => {
                html += `
                    <div class="itinerary">
                        <strong>${itineraries.length > 1 ? (idx === 0 ? 'ANDATA' : 'RITORNO') : 'VOLO'}</strong>
                        <div style="color: #666; margin: 5px 0;">Durata: ${itinerary.duration}</div>
                `;
                
                itinerary.segments.forEach(segment => {
                    const depTime = new Date(segment.departure.at);
                    const arrTime = new Date(segment.arrival.at);
                    
                    html += `
                        <div class="segment">
                            <span class="airport">${segment.departure.iataCode}</span>
                            <span class="arrow">‚Üí</span>
                            <span class="airport">${segment.arrival.iataCode}</span>
                            <div class="flight-info">
                                ${segment.carrier}${segment.flight_number} | 
                                ${depTime.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})} - 
                                ${arrTime.toLocaleTimeString('it-IT', {hour: '2-digit', minute: '2-digit'})}
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            });
            
            return html;
        }
        
        // Storico prezzi
        document.getElementById('history-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const params = new URLSearchParams({
                origin: document.getElementById('hist_origin').value.toUpperCase(),
                destination: document.getElementById('hist_destination').value.toUpperCase(),
                departure_date: document.getElementById('hist_departure').value,
                return_date: document.getElementById('hist_return').value
            });
            
            document.getElementById('history-loading').classList.add('show');
            document.getElementById('history-results').classList.remove('show');
            
            try {
                const response = await fetch('/api/history?' + params);
                const result = await response.json();
                
                if (result.success && result.trend.found) {
                    displayPriceTrend(result.trend);
                } else {
                    document.getElementById('history-results').innerHTML = 
                        '<p>‚ùå Nessuno storico disponibile per questa rotta. Effettua prima una ricerca.</p>';
                    document.getElementById('history-results').classList.add('show');
                }
            } catch (error) {
                showError('history-error', 'Errore: ' + error.message);
            } finally {
                document.getElementById('history-loading').classList.remove('show');
            }
        });
        
        // Visualizza trend prezzi
        function displayPriceTrend(trend) {
            const resultsDiv = document.getElementById('history-results');
            
            const priceChange = trend.price_change;
            const changeEmoji = priceChange < 0 ? 'üìâ' : priceChange > 0 ? 'üìà' : '‚û°Ô∏è';
            const changeColor = priceChange < 0 ? '#28a745' : priceChange > 0 ? '#dc3545' : '#666';
            
            let html = `
                <h3>üìà Trend Prezzi</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨ ${trend.lowest_price.toFixed(2)}</div>
                        <div class="stat-label">Prezzo Pi√π Basso</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨ ${trend.highest_price.toFixed(2)}</div>
                        <div class="stat-label">Prezzo Pi√π Alto</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨ ${trend.average_price.toFixed(2)}</div>
                        <div class="stat-label">Prezzo Medio</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">‚Ç¨ ${trend.current_price.toFixed(2)}</div>
                        <div class="stat-label">Prezzo Attuale</div>
                    </div>
                </div>
                
                <div class="stat-card" style="margin-top: 20px;">
                    <div class="stat-value" style="color: ${changeColor};">
                        ${changeEmoji} ${Math.abs(priceChange).toFixed(2)} ${trend.currency}
                    </div>
                    <div class="stat-label">Variazione Prezzo</div>
                </div>
                
                <div style="margin-top: 20px; color: #666;">
                    <p><strong>Ricerche effettuate:</strong> ${trend.searches_count}</p>
                    <p><strong>Prima ricerca:</strong> ${new Date(trend.first_search).toLocaleString('it-IT')}</p>
                    <p><strong>Ultima ricerca:</strong> ${new Date(trend.last_search).toLocaleString('it-IT')}</p>
                </div>
            `;
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }
        
        // Carica rotte
        async function loadRoutes() {
            document.getElementById('routes-loading').classList.add('show');
            document.getElementById('routes-results').classList.remove('show');
            
            try {
                const response = await fetch('/api/routes');
                const result = await response.json();
                
                if (result.success) {
                    displayRoutes(result.routes);
                }
            } catch (error) {
                console.error('Errore:', error);
            } finally {
                document.getElementById('routes-loading').classList.remove('show');
            }
        }
        
        // Visualizza rotte
        function displayRoutes(routes) {
            const resultsDiv = document.getElementById('routes-results');
            
            if (!routes || routes.length === 0) {
                resultsDiv.innerHTML = '<p>‚ùå Nessuna rotta monitorata. Effettua una ricerca per iniziare.</p>';
                resultsDiv.classList.add('show');
                return;
            }
            
            let html = `<h3>üó∫Ô∏è ${routes.length} Rotte Monitorate</h3>`;
            
            routes.forEach(route => {
                const r = route.route;
                html += `
                    <div class="route-item">
                        <div class="route-header">
                            <span class="route-path">${r.origin} ‚Üí ${r.destination}</span>
                            <span class="route-price">‚Ç¨ ${route.last_price.toFixed(2)}</span>
                        </div>
                        <div class="route-details">
                            Partenza: ${r.departure_date}
                            ${r.return_date ? ' | Ritorno: ' + r.return_date : ''}
                            | Ricerche: ${route.searches_count}
                            | Ultimo aggiornamento: ${new Date(route.last_search).toLocaleString('it-IT')}
                        </div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.classList.add('show');
        }
        
        // Mostra errore
        function showError(elementId, message) {
            const errorDiv = document.getElementById(elementId);
            errorDiv.textContent = message;
            errorDiv.classList.add('show');
        }
        
        // Carica rotte all'avvio se il tab √® attivo
        if (document.getElementById('routes-tab').classList.contains('active')) {
            loadRoutes();
        }
    </script>
</body>
</html>
